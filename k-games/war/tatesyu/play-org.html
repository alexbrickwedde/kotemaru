<!DOCTYPE html>

<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=320,user-scalable=no">
	<meta name="format-detection" content="telephone=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">

	<title>tatesyu</title>
	<link rel="stylesheet" href="css/play.css?20120506_1350" />

	<script src="map.js"></script>
	<script src="Util.js"></script>
	<script>
function Chip(src){this.initialize.apply(this, arguments)};
(function(Class) {
	Class.loading = 0;
	Class.cache = {};

	Class.prototype.initialize = function(src) {
		const self = this;
		var img = new Image();
		this.img = img;
		img.onload = function(){
			var tmpCvs = document.createElement("canvas");
			tmpCvs.setAttribute("width", img.width);
			tmpCvs.setAttribute("height", img.height);
			var ctx = tmpCvs.getContext("2d");
			ctx.drawImage(img, 0, 0);
			self.data = ctx.getImageData(0, 0, img.width, img.height);

			Class.loading--;
			if (Class.loading == 0) {
				Class.onload();
			}
		};
		img.src = src;
		Class.loading++;
	};
	
	Class.add = function(name, src){
		if (Chip.cache[name]) return Class.cache[name];
		Class.cache[name] = new Chip(src);
		return Class.cache[name];
	};	

	Class.onload = function(){};	
})(Chip);

function Actor(game){this.initialize.apply(this, arguments)};
(function(Class) {
	Class.prototype.initialize = function(game) {
		Util.copy(this,{
			game:game, layer:1,
			// ,chip:null, x:0, y:0			
		});
	};

	Class.prototype.paint = function() {
		with (this) {
			// Note:クリッピングにまかせた方が多分早い。
			const img = chip.img;
			//const xx = x - (img.width/2) - game.clipX;
			//const yy = y - (img.height/2) - game.clipY;
			//game.ctx.putImageData(data, xx, yy);
			game.ctx.drawImage(img, 
					x - (img.width/2) - game.clipX,
					y - (img.height/2) - game.clipY
			);
			
		}
	};
})(Actor);

function MyShip(game){this.initialize.apply(this, arguments)};
(function(Class, Super) {
	Util.extend(Class, Super);
	Util.addClass(Class);

	const CHIPS = [];
	(function() {
		const names = ["f_zeroL2","f_zeroL1","f_zero","f_zeroR1","f_zeroR2"];
		for (var i=0; i<names.length; i++) {
			CHIPS.push(Chip.add(names[i], "img/"+names[i]+".png"));
		}
	})();
	
	Class.prototype.isMyShip = true;

	Class.prototype.initialize = function(game) {
		Super.prototype.initialize.apply(this, arguments);

		Util.copy(this,{
			layer:2, chip:CHIPS[2], x:150, y: 6400-320, grad: 0, tick:false
		});
	};

	Class.prototype.action = function() {
		with (Input) {
			this.y -= 2;
			this.tick = !this.tick;
			if (left) {
				if (this.x>16)	this.x -= 4;
				if (this.grad > -2) this.grad--;
			} else if (right) {
				if (this.x<285)	this.x += 4;
				if (this.grad < 2) this.grad++;
			} else {
				if (this.grad > 0) this.grad--;
				if (this.grad < 0) this.grad++;
			}
			
			if (up) {
				this.y -= 4;
			} else if (down) {
				this.y += 4 ;
			}
			
			if (btn1) {
				new Bullet(this.game).init(
					this.x+(this.tick?-4:4),this.y, 
					this.grad*4, -40, 
					this.grad*1, -10);
			}
			this.chip = CHIPS[this.grad+2];
		}
	};
	
	Class.prototype.isHit = function(bullet) {
		with (this) {
			const x0 = x;
			const x1 = x - 12;
			const x2 = x + 12;
			const y1 = y - 15;
			const y2 = y + 10;
			const yy = y - 4;
		}
		with (bullet) {
			if (vy != 0 && (y <= yy && yy <= y+vy || y >= yy && yy >= y+vy) ) {
				const X = (yy-y) * (vx/vy) + x;
				if (x1 <= X && X <= x2) return true;
			}
			if (vx != 0 && (x <= x0 && x0 <= x+vx || x >= x0 && x0 >= x+vx) ) {
				const Y = (x0-x) * (vy/vx) + y;
				if (y1 <= Y && Y <= y2) return true;
			}
			return false;
		}
	};
	
})(MyShip, Actor);

function F4f(game){this.initialize.apply(this, arguments)};
(function(Class, Super) {
	Util.extend(Class, Super);
	Util.addClass(Class);

	const CHIPS = [];
	(function() {
		CHIPS.push(Chip.add("f4f", "img/f4f.png"));
	})();
	
	Class.prototype.isEnemyPlane = true;

	Class.prototype.initialize = function(game) {
		Super.prototype.initialize.apply(this, arguments);

		Util.copy(this,{
			layer:2, chip:CHIPS[0], x:250, y: 6400-620, grad: 0, tick:false
		});
	};

	Class.prototype.action = function() {
		with (this) {
			this.y += 2;
		}
	};
})(F4f, Actor);

function Cannon(game){this.initialize.apply(this, arguments)};
(function(Class, Super) {
	Util.extend(Class, Super);
	Util.addClass(Class);

	const CHIPS = [];
	(function() {
		const names = [
			"cannonR000","cannonR045","cannonR090","cannonR135",
			"cannonR180","cannonR225","cannonR270","cannonR315"
		];
		for (var i=0; i<names.length; i++) {
			CHIPS.push(Chip.add(names[i], "img/cannon/"+names[i]+".png"));
		}
	})();

	Class.prototype.initialize = function(game) {
		Super.prototype.initialize.apply(this, arguments);

		Util.copy(this,{
			layer:1, chip:CHIPS[4], x:150, y: 6400-320, angle:4, count:0
		});
	};

	Class.prototype.action = function() {
		with (this) {
			angle = getAngle(game.myShip.x-x, game.myShip.y-y);
			chip = CHIPS[angle];
			count++;
		}
	};
	function getAngle(x,y) {
		if( x>0 && y<0 ){
		    if( -y/x >= 3 ) return 0;
		    if( x/-y >= 3 ) return 2;
		    return 1 ;
		}
		if( x>0 && y>0 ){
		    if( x/y >= 3 ) return 2;
		    if( y/x >= 3 ) return 4;
		    return 3;
		}
		if( x<0 && y>0 ){
		    if( y/-x >= 3 ) return 4;
		    if( -x/y >= 3 ) return 6;
		    return 5;
		}
		if( x<0 && y<0 ){
		    if( -x/-y >= 3 ) return 6;
		    if( -y/-x >= 3 ) return 0;
		    return 7;
		}
		return 0;
	}

})(Cannon, Actor);

function CannonA(game){this.initialize.apply(this, arguments)};
(function(Class, Super) {
	Util.extend(Class, Super);
	Util.addClass(Class);


	Class.prototype.initialize = function(game) {
		Super.prototype.initialize.apply(this, arguments);
	};

	const SPEED = 30;
	const LEN = 10;
	Class.prototype.action = function() {
		Super.prototype.action.apply(this, arguments);
		with (this) {
			if (50 < count && count < 200) {
				if (count % 5 == 0) {
					const tx = game.myShip.x-x;
					const ty = game.myShip.y-y;
					const len = Math.sqrt(tx*tx+ty*ty);
					const vx = tx * (SPEED / len);
					const vy = ty * (SPEED / len);
					const lx = tx * (LEN / len);
					const ly = ty * (LEN / len);
					new EnemyBullet(this.game).init(x,y, vx,vy, lx,ly);
				}
			}
		}
	};

})(CannonA, Cannon);

function Bullet(game){this.initialize.apply(this, arguments)};
(function(Class, Super) {
	Util.extend(Class, Super);

	const ASTER_CHIP = Chip.add("aster", "img/aster.png");

	Class.prototype.initialize = function(game) {
		Super.prototype.initialize.apply(this, arguments);
		this.layer = 2;
		this.state = 0;
	};
	Class.prototype.init = function(x, y, vx, vy, lx,ly){
		this.x = x;
		this.y = y;
		this.vx = vx;
		this.vy = vy;
		this.lx = lx;
		this.ly = ly;
		this.game.addEntity(this);
	}


	Class.prototype.action = function() {
		with (this) {
			if (x<game.clipX || x>game.clipX+game.clipW 
				|| y<game.clipY || y>game.clipY+game.clipH) {
				game.delEntity(this);
			}
			x += vx;
			y += vy;
		}
	};

	Class.prototype.paint = function() {
		with (this) {
			if (state>0) return this.paintNext();
			const xx = x - game.clipX;
			const yy = y - game.clipY;
			const ctx = game.ctx;
			ctx.beginPath();
			ctx.strokeStyle = "orange";
			ctx.moveTo(xx,yy);
			ctx.lineTo(xx+lx, yy+ly);
			ctx.stroke();
		}
	};
	
	Class.prototype.paintNext = function() {
		with (this) {
			game.ctx.drawImage(ASTER_CHIP.img, x-5-game.clipX,y-5-game.clipY);
			if (state++ > 2) {
				game.delEntity(this);
			}
		}
	};
	
})(Bullet,Actor);

function EnemyBullet(game){this.initialize.apply(this, arguments)};
(function(Class, Super) {
	Util.extend(Class, Super);

	Class.prototype.action = function() {
		if (this.game.myShip.isHit(this)) {
			this.state = 1;
			this.vx = 0;
			this.vy = 0;
		}
		Super.prototype.action.apply(this, arguments);
	};
	
})(EnemyBullet,Bullet);

function Input(game){this.initialize.apply(this, arguments)};
(function(Class, Super) {
	Util.extend(Class, Super);
	Util.addClass(Class);

	const KEYCODE = {
		37: "left",  //←
		38: "up",    //↑
		39: "right", //→
		40: "down",  //↓
		88: "btn1", //x
		89: "btn2",  //y
	}
	for (var k in KEYCODE) {
		Class[KEYCODE[k]] = false;
	}

	document.onkeydown = function(ev){
		var name = KEYCODE[ev.keyCode];
		if (name === undefined) return false;
		Class[name] = true;
		return false;
	};
	document.onkeyup = function(ev){
		var name = KEYCODE[ev.keyCode];
		if (name === undefined) return false;
		Class[name] = false;
		return false;
	};
})(Input);

function Map(game){this.initialize.apply(this, arguments)};
(function(Class, Super) {
	Util.extend(Class, Super);
	Util.addClass(Class);

	var MAP = [];
	(function() {
		for (var y = 0; y < 200; y++) {
			MAP.push(new Array(10));
		}
		for (var i=0; i<MAP_DATA.length; i++) {
			var x = MAP_DATA[i][0];
			var y = MAP_DATA[i][1];
			var name = MAP_DATA[i][2];
			MAP[y][x] = name;
			Chip.add(name, "img/map/"+name+".png");
		}
	})();

	Class.prototype.initialize = function(game) {
		Util.copy(this,{game:game, layer:0});
	};

	Class.prototype.paint = function() {
		const chips = Chip.cache;
		const ctx = this.game.ctx;
		const margin = this.game.clipY % 32;
		const top = Math.floor(this.game.clipY /32);
	
		for (var y=0; y<14; y++) {
			var yy = y*32 - margin;
			for (var x = 0; x < 10; x++) {
				ctx.putImageData(chips[MAP[y+top][x]].data, x * 32, yy);
			}
		}
	};
})(Map);

function Game(game){this.initialize.apply(this, arguments)};
(function(Class, Super) {
	Util.extend(Class, Super);
	Util.addClass(Class);
	var instance;

	Class.prototype.initialize = function(game) {
		var canvas = document.getElementById("canvas");
		Util.copy(this,{
			canvas: canvas,
			ctx : canvas.getContext("2d"),
			clipX : 0,
			clipY : 6400-(32*14),
			clipW : 300,
			clipH : 400,
			actors : {},
			layers : [{},{},{}],
			idCount : 0,
			myShip : null,
		});
		Class.instance = this;
	};

	Class.prototype.setMyShip = function(entity){
		this.myShip = entity;
	}
	Class.prototype.addEntity = function(entity) {
		with (this) {
			const id = this.idCount++;
			entity.id = id;
			if (entity.action) actors[id] = entity;
			if (entity.paint) layers[entity.layer][id] = entity;
		}
	}
	Class.prototype.delEntity = function(entity) {
		with (this) {
			const id = entity.id;
			delete actors[id];
			delete layers[entity.layer][id];
		}
	}
	Class.prototype.start = function(){
		ticker();
	}
	
	function ticker() {
		with (Class.instance) {
			clipY -= 2;
			for (var id in actors) actors[id].action();
			for (var id in layers[0]) layers[0][id].paint();
			for (var id in layers[1]) layers[1][id].paint();
			for (var id in layers[2]) layers[2][id].paint();
		}
		setTimeout(ticker, 50);
	}

})(Game);

function onLoad(){
	if (Chip.loading > 0) {
		Chip.onload = onLoad2;
	} else {
		onLoad2();
	}
}

function onLoad2() {
	var game = new Game();
	var map = new Map(game);
	var myShip = new MyShip(game);
	var cannon = new CannonA(game);
	var f4f = new F4f(game);

	game.setMyShip(myShip);

	game.addEntity(map);
	game.addEntity(myShip);
	game.addEntity(cannon);
	game.addEntity(f4f);

	game.start();
}


	</script>

</head>

<body onload="onLoad()">

<canvas id="canvas" width="300" height="400" ></canvas>


</body>

</html>
