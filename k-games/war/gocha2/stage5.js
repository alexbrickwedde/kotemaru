
var stage5 = (function(){
	var CHIP_MAP =Chip.create("img/FSM/stage3-map.png");
	var CHARS_0 = {
		//  味方
		fighter: {
			chip:Chip.create("img/usui/Actor_etc1a.png"),
			hp:300, ar:50,ap:50, dr:50,dp:50,
			bx:9, by:17, dir:"U"
		},
	};
	
	CHARS_1 = {
		// 敵
		fighter: {
			chip:Chip.create("img/usui/Actor_etc1b.png"),
			hp:300, ar:50,ap:50, dr:50,dp:50,
			bx:9, by:3, dir:"D"
		},
	};
	
	function makeMap(game){
		var backgroundMap = new Map(16, 16);
		backgroundMap.image = game.assets[CHIP_MAP.src];
		backgroundMap.loadData([
		                        [206,206,206,206,206,206,206,206,206,206,206,206,237,238,238,238,238,238,238,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,237,238,238,238,238,238,238,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,237,238,238,238,238,238,238,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,253,238,238,238,238,238,238,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,253,238,238,238,238,238,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,253,254,254,238,238,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,253,254,254],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,253,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,253],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,221],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,221,222,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,237,238,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,253,238,238],
		                        [206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,253,238],
		                        [223,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,237],
		                        [238,222,223,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,253],
		                        [238,238,238,223,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206],
		                        [238,238,238,239,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206,206]
		                    ],[
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,79,79,79,79,79],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,79,79,63,79,79],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,79,63,79,79,79],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,79,79,63,79],
		                        [-1,-1,-1,47,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,79],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,47,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,47,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,79],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,79],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,47,-1,-1,-1,-1],
		                        [79,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [79,79,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
		                    ]);
		                    backgroundMap.collisionData = [
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
		                        [0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
		                    ];
        return backgroundMap
	}
	function makeMap2(game){
		var backgroundMap = new Map(16, 16);
		backgroundMap.image = game.assets[CHIP_MAP.src];
		backgroundMap.loadData([
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,163,164,165,166,167,-1,-1,163,164,165,166,167],
            [-1,-1,-1,-1,-1,-1,-1,-1,179,180,181,182,183,-1,-1,179,180,181,182,183],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
        ]);
        return backgroundMap
	}

	function makeActor(data) {
		var chip = new VXChip(data.chip, data.attack);
		var params = GochaUtil.copy({}, data);
		delete params.chip;
		delete params.attack;
		return new GochaActor(chip, params);
	}
	
	
	function makeStage(game) {
    	// 味方チーム作成
    	var plat0 = new GochaPlatoon(0);
    	plat0.setLeader(makeActor(CHARS_0.fighter));
   		for (var i=0;i<14;i++) {
   			plat0.addGocha(makeActor(CHARS_0.fighter));
   		}
	
    	// 敵チーム作成
    	var plat1 = new GochaPlatoon(1);
    	plat1.setLeader(makeActor(CHARS_1.fighter));
   		for (var i=0;i<14;i++) {
   			plat1.addGocha(makeActor(CHARS_1.fighter));
   		}
	
   		// マップとGochaMainを作成して登録。
    	var main = new GochaMain(game, makeMap(game));
    	main.addGocha(plat1);
    	main.addGocha(plat0);
    	
 	
    	// 開始準備OKの処理
   		main.addEventListener("gocha.ready", function(ev){
   	    	main.command(1,"attack",{"for":"all"}); // 敵に戦闘開始命令
   	    	main.ctrl.show(true); // 自軍命令メニュー表示
  		});
   		// キャラ死亡通知
   		main.addEventListener("gocha.dead", function(ev){
			var ev;
   			if (plat1.getMemberCount() == 0) {
				// 敵全滅、勝利
				ev = new Event("gocha.win");
				ev.message = "何とか勝ったな。しかし勝負は時の運だ。";
   			} else if (plat0.getMemberCount() == 0) {
				// 味方全滅、敗北
				ev = new Event("gocha.lost");
				ev.message = "くそー負けたか。しかし勝負は時の運だ。";
   			}
			game.dispatchEvent(ev);
   		});
  		
   		
   		// ステージタイトルダイアログ
   	   	main.addEventListener("gocha.onload", function(ev){
   			game.pause();
   	    	GochaDialog.open(main, {
   	    		title:"第５話  決戦", 
   	    		message:"戦力は互角、小細工無しの真向勝負だ。",
   	    		ok:function(){game.resume();}
   	    	});
  		});
   		return main;
	}
	
	return makeStage;
})();
