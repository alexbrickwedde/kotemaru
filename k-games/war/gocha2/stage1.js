
var stage1 = (function(){
	var CHIP = {
		map:      Chip.create("img/usui/wafuu/stage1-map.png"),
		katana:   Chip.create("img/attack-wa.png"),
		
		bakatono: Chip.create("img/usui/wafuu/Actor_etc8.png"),
		warutono: Chip.create("img/usui/wafuu/Actor_etc9.png"),
		rounin:   Chip.create("img/usui/wafuu/Actor_etc5.png"),
		shinsen:  Chip.create("img/usui/wafuu/Actor_etc3.png"),
	};
	
	function makeMap(game){
		var backgroundMap = new Map(16, 16);
		backgroundMap.image = game.assets[CHIP.map.src];
		backgroundMap.loadData([
		                        [0,0,0,0,0,0,178,180,180,180,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,178,180,180,180,0,0,0,0,0,0,0,0,0,0],
		                        [18,18,16,17,18,18,178,180,180,180,18,16,17,18,18,50,51,52,48,18],
		                        [49,49,32,33,49,49,178,180,180,180,48,32,33,49,49,66,67,68,65,49],
		                        [49,49,49,49,49,49,178,180,180,180,48,48,48,48,48,82,83,84,80,49],
		                        [65,65,65,65,65,65,178,180,180,180,64,64,64,64,64,98,99,100,96,65],
		                        [80,81,80,81,80,81,178,180,180,180,80,81,80,81,80,114,115,116,144,81],
		                        [96,97,96,97,96,97,178,180,180,180,96,97,96,97,96,130,131,132,160,97],
		                        [161,161,161,161,161,161,178,180,180,180,112,113,112,113,112,161,115,116,161,112],
		                        [161,161,161,161,161,161,178,180,180,180,128,129,128,129,128,161,131,132,161,128],
		                        [161,161,161,161,161,161,178,180,180,180,161,161,145,145,161,161,115,116,161,161],
		                        [161,161,161,161,161,161,178,180,180,180,161,161,161,144,161,161,131,132,161,161],
		                        [198,199,198,199,198,199,194,194,194,194,198,199,198,199,198,199,198,199,198,199],
		                        [214,215,214,215,214,215,210,210,210,210,214,215,214,215,214,215,214,215,214,215],
		                        [198,199,198,199,198,199,194,194,194,194,198,199,198,199,198,199,198,199,198,199],
		                        [214,215,214,215,214,215,210,210,210,210,214,215,214,215,214,215,214,215,214,215],
		                        [161,161,161,161,161,161,226,227,228,229,161,161,161,161,161,161,161,161,161,161],
		                        [161,161,161,161,161,161,242,243,244,245,161,161,161,161,161,161,161,161,161,161],
		                        [161,161,161,161,161,161,178,180,180,180,161,161,161,161,161,161,161,161,161,161],
		                        [161,161,161,161,161,161,178,180,180,180,161,161,161,161,161,161,161,161,161,161]
		                    ],[
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,117,118,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,133,134,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,149,150,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,165,166,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,149,150,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,165,166,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
		                    ]);
		                    backgroundMap.collisionData = [
		                        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		                        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		                        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		                        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		                        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
		                        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1],
		                        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1],
		                        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1],
		                        [0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,1],
		                        [0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,1],
		                        [0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
		                        [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0]
		                    ];
		
		return backgroundMap;
	}
	function makeMap2(game){
		var backgroundMap = new Map(16, 16);
		backgroundMap.image = game.assets[CHIP.map.src];
		backgroundMap.loadData([
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,117,118,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,133,134,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
		                        [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
        ]);
        return backgroundMap
	}

	function makeStage(game) {
		// VX互換チップ＋攻撃エフェクトに日本刀。
    	var chips = {
   			bakatono: new VXChip(CHIP.bakatono, CHIP.katana),
   			warutono: new VXChip(CHIP.warutono, CHIP.katana),
   			rounin:   new VXChip(CHIP.rounin,   CHIP.katana),
   			shinsen:  new VXChip(CHIP.shinsen,  CHIP.katana),
    	};
		// キャラ属性：max_hp,hp:体力、ar,ap:攻撃率,力、 dr,dp:防御率,力, 
    	//   bx,by:初期座標(マップタイル座標)、dir:初期方向
    	var params = {
    		// 敵
      		warutono: {hp:100, ar: 50,ap: 50, dr: 50,dp: 50, 
      					bx:2,by: 14,dir:"R"},
       		rounin:   {hp:200, ar:100,ap:100, dr:100,dp: 70},
       		// 味方
       		bakatono: {hp:100, ar: 50,ap: 50, dr: 50,dp: 50, 
       					bx:14,by:14,dir:"L"},
       		shinsen:  {hp:300, ar:200,ap:150, dr:150,dp:120},
    	};
    	
    	// 敵チーム作成
    	var plat1 = new GochaPlatoon(1);
    	plat1.setLeader(new GochaActor(chips.warutono, params.warutono));
   		for (var i=0;i<14;i++) {
   			plat1.addGocha(new GochaActor(chips.rounin, params.rounin));
   		}
  		
    	// 味方チーム作成
    	var plat0 = new GochaPlatoon(0);
    	plat0.setLeader(new GochaActor(chips.bakatono, params.bakatono));
   		for (var i=0;i<4;i++) {
   			plat0.addGocha(new GochaActor(chips.shinsen, params.shinsen));
   		}
  	
   		// マップとGochaMainを作成して登録。
    	var main = new GochaMain(game, makeMap(game));
    	main.addGocha(plat1);
    	main.addGocha(plat0);
    	// オーバラップマップ
    	var fgMap = makeMap2(game);
    	//fgMap.opacity = 0.9;
    	fgMap._style.zIndex = 1000;
    	main.addChild(fgMap);
   	
    	// 開始準備OKの処理
   		main.addEventListener("gocha.ready", function(ev){
   	    	main.command(1,"attack"); // 敵に戦闘開始命令
   	    	main.command(1,"escape",{"for":"leader"});
   	    	main.ctrl.show(true); // 自軍命令メニュー表示
  		});
   		// キャラ死亡通知
   		main.addEventListener("gocha.dead", function(ev){
   			if (ev.isLeader) {
   				var ev;
   				if (ev.actor.team != 0) {
 					// 敵リーダー死亡、勝利
 					ev = new Event("gocha.win");
   					ev.message = "なんとかバカ殿を守りきったものの悪代官がこのまま引き下がろうはずも無かった...";
   				} else {
   					// 味方リーダー死亡、敗北
   					ev = new Event("gocha.lost");
   					ev.message = "くっ、なんと言うことだバカ殿を斬られてしまうとは...";
  				}
				game.dispatchEvent(ev);
  			}
   		});
   		
   		
   		// ステージタイトルダイアログ
   	   	main.addEventListener("gocha.onload", function(ev){
   			game.pause();
   	    	GochaDialog.open(main, {
   	    		title:"第１話  バカ殿 vs 悪代官", 
   	    		message:"京の町を散策中のバカ殿を悪代官一味が襲った。<br/>"
   	    				+"護衛の新鮮組はバカ殿を守りきれるか。",
   	    		ok:function(){game.resume();}
   	    	});
  		});
   		return main;
	}
	
	return makeStage;
})();
