
var stage2 = (function(){
	var CHIP = {
		map:      Chip.create("img/usui/wafuu/stage2-map.png"),
		katana:   Chip.create("img/attack-wa.png"),
		
		bakatono: Chip.create("img/usui/wafuu/Actor_etc8.png"),
		warutono: Chip.create("img/usui/wafuu/Actor_etc9.png"),
		samurai:  Chip.create("img/usui/wafuu/Actor_etc2.png"),
		shinsen:  Chip.create("img/usui/wafuu/Actor_etc3.png"),
	};
	
	function makeMap(game){
		var backgroundMap = new Map(16, 16);
		backgroundMap.image = game.assets[CHIP.map.src];
		backgroundMap.loadData([
            [14,14,14,1,1,1,1,33,34,33,34,33,34,1,1,1,1,14,14,14],
            [14,14,14,16,17,16,17,2,2,2,2,2,2,16,17,16,17,14,14,14],
            [14,14,14,0,1,0,1,2,2,2,2,2,2,0,1,0,1,14,14,14],
            [14,14,14,16,17,16,17,2,2,2,2,2,2,16,17,16,17,14,14,14],
            [14,14,14,0,1,0,1,2,2,2,2,2,2,0,1,0,1,14,14,14],
            [14,14,14,16,17,16,17,2,2,2,2,2,2,16,17,16,17,14,14,14],
            [14,14,14,0,1,0,1,2,2,2,2,2,2,0,1,0,1,14,14,14],
            [14,14,14,16,17,16,17,2,2,2,2,2,2,16,17,16,17,14,14,14],
            [14,14,14,0,1,0,1,2,2,2,2,2,2,0,1,0,1,14,14,14],
            [14,14,14,16,17,16,17,2,2,2,2,2,2,16,17,16,17,14,14,14],
            [14,14,14,0,1,0,1,2,2,2,2,2,2,0,1,0,1,14,14,14],
            [14,14,14,16,17,16,17,2,2,2,2,2,2,16,17,16,17,14,14,14],
            [14,14,14,0,1,0,1,2,2,2,2,2,2,0,1,0,1,14,14,14],
            [14,14,14,16,17,16,17,2,6,6,6,6,2,16,5,0,17,14,14,14],
            [14,14,14,0,1,0,1,2,6,6,6,6,2,0,21,0,1,14,14,14],
            [14,14,14,16,17,16,17,2,2,2,2,2,2,16,17,16,17,14,14,14],
            [14,14,14,0,1,0,1,2,2,2,2,2,2,0,1,0,1,14,14,14],
            [14,14,14,16,17,16,17,2,2,2,2,2,2,16,17,16,17,14,14,14],
            [14,14,14,0,1,0,1,2,2,2,2,2,2,0,1,0,1,14,14,14],
            [14,14,14,45,46,46,46,49,50,49,50,49,50,46,46,46,47,14,14,14]
        ],[
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,176,177,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [244,245,246,247,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,244,245,246,247],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [244,245,246,247,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,244,245,246,247],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [244,245,246,247,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,244,245,246,247],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [244,245,246,247,-1,-1,210,211,-1,-1,-1,-1,210,211,-1,-1,244,245,246,247],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [244,245,246,247,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,244,245,246,247],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
        ]);
		backgroundMap.collisionData = [
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,0,0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,0,0],
           [0,1,1,0,0,0,1,1,0,0,0,0,1,1,0,0,0,1,1,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
           [0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0],
           [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
       ];
		
		return backgroundMap;
	}
	function makeMap2(game){
		var backgroundMap = new Map(16, 16);
		backgroundMap.image = game.assets[CHIP.map.src];
		backgroundMap.loadData([
            [212,213,214,215,-1,160,161,-1,-1,-1,-1,-1,-1,-1,-1,-1,212,213,214,215],
            [228,229,230,231,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,228,229,230,231],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [196,197,198,199,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,196,197,198,199],
            [212,213,214,215,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,212,213,214,215],
            [228,229,230,231,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,228,229,230,231],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [196,197,198,199,-1,96,97,98,98,98,98,98,99,100,101,-1,196,197,198,199],
            [212,213,214,215,-1,112,114,115,116,116,116,116,116,116,117,-1,212,213,214,215],
            [228,229,230,231,-1,-1,130,131,134,132,133,134,136,137,-1,-1,228,229,230,231],
            [-1,-1,-1,-1,-1,-1,146,147,151,148,149,151,152,153,-1,-1,-1,-1,-1,-1],
            [196,197,198,199,-1,-1,162,163,-1,-1,-1,-1,162,163,-1,-1,196,197,198,199],
            [212,213,214,215,-1,-1,178,179,-1,-1,-1,-1,178,179,-1,-1,212,213,214,215],
            [228,229,230,231,-1,-1,194,195,-1,-1,-1,-1,194,195,-1,-1,228,229,230,231],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [196,197,198,199,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,196,197,198,199],
            [212,213,214,215,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,212,213,214,215],
            [228,229,230,231,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,228,229,230,231],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],
            [-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]
        ]);
		return backgroundMap;
	}

	function makeStage(game) {
		// VX互換チップ＋攻撃エフェクトに日本刀。
    	var chips = {
   			bakatono: new VXChip(CHIP.bakatono, CHIP.katana),
   			warutono: new VXChip(CHIP.warutono, CHIP.katana),
   			samurai:   new VXChip(CHIP.samurai,   CHIP.katana),
   			shinsen:  new VXChip(CHIP.shinsen,  CHIP.katana),
    	};
		// キャラ属性：max_hp,hp:体力、ar,ap:攻撃率,力、 dr,dp:防御率,力, 
    	//   bx,by:初期座標(マップタイル座標)、dir:初期方向
    	var params = {
    		// 敵
      		warutono: {max_hp:100,hp:100, ar: 50,ap: 50, dr: 50,dp: 50, 
      					bx:9,by: 3,dir:"D"},
       		samurai:  {max_hp:300,hp:300, ar:200,ap:150, dr:150,dp:120},
       		// 味方
       		bakatono: {max_hp:100,hp:100, ar: 50,ap: 50, dr: 50,dp: 50, 
       					bx:9,by:17,dir:"U"},
       		shinsen:  {max_hp:300,hp:300, ar:200,ap:150, dr:150,dp:120},
    	};
    	
    	// 敵チーム作成
    	var plat1 = new GochaPlatoon(1);
    	plat1.setLeader(new GochaActor(chips.warutono, params.warutono));
   		for (var i=0;i<12;i++) {
   			plat1.addGocha(new GochaActor(chips.samurai, params.samurai));
   		}
   		
    	// 味方チーム作成
    	var plat0 = new GochaPlatoon(0);
    	plat0.setLeader(new GochaActor(chips.bakatono, params.bakatono));
   		for (var i=0;i<12;i++) {
   			plat0.addGocha(new GochaActor(chips.shinsen, params.shinsen));
   		}
  	
   		// マップとGochaMainを作成して登録。
    	var main = new GochaMain(game, makeMap(game));
    	main.addGocha(plat1);
    	main.addGocha(plat0);
    	
    	var fgMap = makeMap2(game);
    	//fgMap.opacity = 0.9;
    	fgMap._style.zIndex = 1000;
    	main.addChild(fgMap);

    	// 開始準備OKの処理
   		main.addEventListener("gocha.ready", function(ev){
   	    	main.command(1,"attack"); // 敵に戦闘開始命令
   	    	main.command(1,"escape",{"for":"leader"});
  	    	main.ctrl.show(true); // 自軍命令メニュー表示
  		});
   		// キャラ死亡通知
   		main.addEventListener("gocha.dead", function(ev){
   			if (ev.isLeader) {
   				var ev;
   				if (ev.actor.team != 0) {
 					// 敵リーダー死亡、勝利
 					ev = new Event("gocha.win");
   					ev.message = "悪代官は敗れ去った。しかし第二第三の悪代官が現れるかもしれない。<br/>" +
   							"戦えバカ殿、頑張れバカ殿。";
   				} else {
   					// 味方リーダー死亡、敗北
   					ev = new Event("gocha.lost");
   					ev.message = "悪代官:「うぇはっはっはっ！ この世に正義の栄えた試しは無い。」<br/>" +
   							"京の町は悪代官の手に落ちてしまった。";
  				}
				game.dispatchEvent(ev);
  			}
   		});
   		
   		
   		// ステージタイトルダイアログ
   	   	main.addEventListener("gocha.onload", function(ev){
   			game.pause();
   	    	GochaDialog.open(main, {
   	    		title:"第２話  悪代官の本気", 
   	    		message:"返り打ちにあった悪代官が精鋭をつれて再び挑んできた。<br/>"
   	    				+"桜咲く境内で散るのはどっちだ。",
   	    		ok:function(){game.resume();}
   	    	});
  		});
   		return main;
	}
	
	return makeStage;
})();
